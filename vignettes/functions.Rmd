---
title: "Untitled"
author: "Gaurav"
date: "April 8, 2019"
output: html_document
---

```{r}
set.seed(123)
startPos <- sample(1e6,nreads)
reads <- NULL
for(i in 1:nreads){
      if(startPos[i] + 9999 > 1e6){
            reads <- c(reads,substr(ecoli1M,startPos[i],1e6))
      }
      else{
            reads <- c(reads,substr(ecoli1M,startPos[i],startPos[i] + 9999))
      }
      
}
```

```{r}
error = 0.1
nucleotides <- c('a','t','c','g')
```

```{r}
flipReads <- function(rds,error){
flippedReads <- NULL
for(i in seq(1,length(rds))){
subread <- rds[i]
subreadLen <- nchar(subread)
nErrors <- floor(subreadLen * error)
subread <- strsplit(subread,'')[[1]]
subread <- flipBase(subread,subreadLen,nErrors)
flippedReads <- c(flippedReads, paste0(subread,collapse = ''))
}
return(flippedReads)
}
```

```{r}
flipBase <- function(read,readLen,nErr){
samp <- sample(readLen,nErr)
for(i in 1:length(samp)){
      basePos <- which(nucleotides == read[samp[i]])
      read[samp[i]] <- sample(nucleotides[-basePos],1)
}
return(read)
}
```

```{r}
for(i in 6:20){
print(i)
flippedReads <- reads
flippedReads <- flipReads(flippedReads,i/100)
print(sum(strsplit(reads[2],'')[[1]] != strsplit(flippedReads[2],'')[[1]]))
readID <- paste0('@read_',1:3000,'\n')
readIdNflpdReads <- paste0(readID,toupper(flippedReads))
setwd("D:/JHU/Spring19/601.749ComparativeGenomics/Project/bioSeqGen/data/try")
filename = paste0("flippedReadsWithError",as.character(i),"Pcent.fq")
write(readIdNflpdReads,file = filename)
}
#write(readIdNflpdReads5,file = 'ecoli_5pcent_error_reads.fasta')
```
```{r}
#Count kmers
kmerLen = 21
kmerEndPos = nchar(ecoliGenome) - kmerLen + 1
kmers <- NULL
for(i in 1:kmerEndPos){
      kmers <- c(kmers,substr(ecoliGenome,i,i+20))
}
kmerFreq <- table(kmers)
beepr::beep(8)
```

```{r}
#kmers for reads
readKmers <- NULL
for(i in 1:length(flippedReads)){
      kmerEndPos = nchar(flippedReads[i]) - kmerLen + 1
      for(j in 1:kmerEndPos){
            readKmers <- c(readKmers,substr(flippedReads[i],j,j+kmerLen-1))
      }
freqReadKmers <- table(readKmers)
beepr::beep(8)
}
```


```{r}
read.fasta('data/ecoliGenome.fasta') -> ecoliSeq
ecoliSeq
ecoliSeq$NC_011750.1
View(ecoliSeq)
paste0(ecoliSeq$NC_011750.1)
paste0(ecoliSeq$NC_011750.1,collapse = '') -> ecoliGenome
nchars(ecoliGenome)
length(ecoliGenome)
ecoliGenome <- ecoliGenome[1]
length(ecoliGenome)
nchars(ecoliGenome)
nchar(ecoliGenome)
ecoli1M <- substr(ecoliGenome,1,1e6)
```

```{r}
setwd("D:/JHU/Spring19/601.749ComparativeGenomics/Project")
kmerDf <- list()
num <- 1
dfKmers <- data.frame(count = 1:210)
for(i in seq(0,15,3)){
      filename <- paste0(as.character(i),'pcent21mer.histo')
      kmerDf[[num]] <- read.table(filename,sep = ' ',header = F)
      dfKmers[[paste0('err',as.character(i))]] <- 0
      dfKmers[,(num + 1)][which(dfKmers$count %in% kmerDf[[num]]$V1)] <- kmerDf[[num]]$V2
      num <- num + 1
}
```
```{r}
library(reshape2)
library(ggplot2)
dfKmersMelt <- melt(dfKmers, id.vars = 1)
colnames(dfKmersMelt)[2] <- "Error"
ggplot(dfKmersMelt,aes(x=count,y=log10(value),colour = Error)) + geom_line() + xlab("Kmer Count") + ylab("Log10(#kmers)") + labs(color = "Error %\n")
```
#generate kmers from the 1st 1000 bases
```{r}
ecoli1k <- substr(ecoli1M,1,100000)
kmers <- NULL
kmerEndPos = nchar(ecoli1k) - 20
for(i in seq(1,kmerEndPos,20)){
      kmers <- c(kmers, substr(ecoli1k,i,i+20))
}
```

```{r}
library(stringdist)
kmerDist <- stringdistmatrix(kmers)
kmerMat <- as.matrix(kmerDist)
table(kmerMat)[1:5]
```
Found only adjoining kmers have smaller distance of 2 with each other 